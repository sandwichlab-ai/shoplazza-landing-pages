name: Production Deploy

on:
  push:
    branches: [main]
    paths:
      - 'workshops/**'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed versions
        id: detect
        run: |
          echo "Detecting changed versions..."

          # è·å–å˜æ›´çš„æ–‡ä»¶
          CHANGED=$(git diff --name-only HEAD~1 HEAD -- workshops/ || echo "")
          echo "Changed files:"
          echo "$CHANGED"

          # æå–å”¯ä¸€çš„ version è·¯å¾„
          VERSIONS=$(echo "$CHANGED" | grep -oP 'workshops/[^/]+/projects/[^/]+/versions/[^/]+' | sort -u || echo "")
          echo "Changed versions:"
          echo "$VERSIONS"

          # å–ç¬¬ä¸€ä¸ªç‰ˆæœ¬è·¯å¾„
          FIRST_VERSION=$(echo "$VERSIONS" | head -1)
          echo "first_version=$FIRST_VERSION" >> $GITHUB_OUTPUT

          echo "versions<<EOF" >> $GITHUB_OUTPUT
          echo "$VERSIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Push theme to Shoplazza via API
        if: steps.detect.outputs.first_version != ''
        env:
          SHOPLAZZA_SHOP_DOMAIN: ${{ secrets.SHOPLAZZA_SHOP_DOMAIN }}
          SHOPLAZZA_ACCESS_TOKEN: ${{ secrets.SHOPLAZZA_ACCESS_TOKEN }}
          SHOPLAZZA_THEME_ID: ${{ secrets.SHOPLAZZA_THEME_ID }}
        run: |
          VERSION_PATH="${{ steps.detect.outputs.first_version }}"
          THEME_DIR="$VERSION_PATH/theme"

          echo "Pushing theme from: $THEME_DIR"

          # æ›´æ–° sections/page_detail.liquid æ–‡ä»¶
          LIQUID_FILE="$THEME_DIR/sections/page_detail.liquid"
          if [ ! -f "$LIQUID_FILE" ]; then
            echo "Error: page_detail.liquid not found"
            exit 1
          fi

          # è¯»å–æ–‡ä»¶å†…å®¹å¹¶è½¬ä¹‰ä¸º JSON
          CONTENT=$(cat "$LIQUID_FILE" | jq -Rs .)

          # ä½¿ç”¨ Shoplazza Theme API æ›´æ–°æ–‡ä»¶ (API ç‰ˆæœ¬ 2020-07)
          API_URL="https://${SHOPLAZZA_SHOP_DOMAIN}.myshoplaza.com/openapi/2020-07/themes/${SHOPLAZZA_THEME_ID}/doc"

          echo "Updating file via API: $API_URL"

          RESPONSE=$(curl -s -X PATCH "$API_URL" \
            -H "Access-Token: ${SHOPLAZZA_ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"doc\": {
                \"type\": \"sections\",
                \"location\": \"page_detail.liquid\",
                \"content\": $CONTENT
              }
            }")

          echo "API Response: $RESPONSE"

          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ (API è¿”å› [] è¡¨ç¤ºæˆåŠŸ, æˆ–è€…è¿”å›åŒ…å« errors çš„ JSON è¡¨ç¤ºå¤±è´¥)
          if [ "$RESPONSE" = "[]" ]; then
            echo "âœ… Theme file updated successfully!"
          elif echo "$RESPONSE" | grep -q '"errors"'; then
            echo "Error updating theme file"
            echo "$RESPONSE"
            exit 1
          else
            # å…¶ä»–å“åº”ä¹Ÿè§†ä¸ºæˆåŠŸ (ä¾‹å¦‚è¿”å›æ›´æ–°åçš„ doc ä¿¡æ¯)
            echo "âœ… Theme file updated (response: $RESPONSE)"
          fi

      - name: Deploy to Shoplazza
        if: steps.detect.outputs.first_version != ''
        env:
          SHOPLAZZA_SHOP_DOMAIN: ${{ secrets.SHOPLAZZA_SHOP_DOMAIN }}
          SHOPLAZZA_ACCESS_TOKEN: ${{ secrets.SHOPLAZZA_ACCESS_TOKEN }}
        run: |
          echo "Deploying to Shoplazza..."

          VERSION_PATH="${{ steps.detect.outputs.first_version }}"
          THEME_DIR="$VERSION_PATH/theme"

          if [ ! -d "$THEME_DIR" ]; then
            echo "Error: Theme directory not found: $THEME_DIR"
            exit 1
          fi

          # æ£€æŸ¥å‡­è¯
          if [ -z "$SHOPLAZZA_SHOP_DOMAIN" ] || [ -z "$SHOPLAZZA_ACCESS_TOKEN" ]; then
            echo "Error: Missing Shoplazza credentials"
            echo "Please set SHOPLAZZA_SHOP_DOMAIN and SHOPLAZZA_ACCESS_TOKEN secrets"
            exit 1
          fi

          echo "Theme directory: $THEME_DIR"
          echo "Shop domain: $SHOPLAZZA_SHOP_DOMAIN"

          # è¯»å– page_detail.liquid å†…å®¹
          LIQUID_FILE="$THEME_DIR/sections/page_detail.liquid"
          if [ ! -f "$LIQUID_FILE" ]; then
            echo "Error: page_detail.liquid not found"
            exit 1
          fi

          echo "Found Liquid file: $LIQUID_FILE"
          echo "File size: $(wc -c < "$LIQUID_FILE") bytes"

          # æå–ç‰ˆæœ¬ä¿¡æ¯ç”¨äºé¡µé¢ handle
          # è·¯å¾„æ ¼å¼: workshops/spring-festival/projects/landing/versions/v14
          WORKSHOP=$(echo "$VERSION_PATH" | cut -d'/' -f2)
          PROJECT=$(echo "$VERSION_PATH" | cut -d'/' -f4)
          VERSION=$(echo "$VERSION_PATH" | cut -d'/' -f6)
          PAGE_HANDLE="ai-landing-${PROJECT}-${VERSION}"

          echo "Workshop: $WORKSHOP"
          echo "Project: $PROJECT"
          echo "Version: $VERSION"
          echo "Page handle: $PAGE_HANDLE"

          # åˆ›å»º/æ›´æ–°é¡µé¢ (ä½¿ç”¨ 2025-06 API ç‰ˆæœ¬)
          API_URL="https://${SHOPLAZZA_SHOP_DOMAIN}.myshoplaza.com/openapi/2025-06/pages"

          PAGE_TITLE="AI Landing Page - ${PROJECT} ${VERSION}"

          # æ£€æŸ¥é¡µé¢æ˜¯å¦å·²å­˜åœ¨ (é€šè¿‡åˆ—å‡ºæ‰€æœ‰é¡µé¢å¹¶æŒ‰æ ‡é¢˜æœç´¢)
          echo "Checking if page exists..."
          EXISTING=$(curl -s -X GET "${API_URL}?page_size=50" \
            -H "Access-Token: ${SHOPLAZZA_ACCESS_TOKEN}" \
            -H "Content-Type: application/json")

          # æŸ¥æ‰¾æ ‡é¢˜åŒ¹é…çš„é¡µé¢
          PAGE_ID=$(echo "$EXISTING" | jq -r --arg title "$PAGE_TITLE" '.data.pages[]? | select(.title == $title) | .id' | head -1)

          if [ -n "$PAGE_ID" ] && [ "$PAGE_ID" != "null" ]; then
            echo "Page exists (ID: $PAGE_ID), updating title..."
            RESPONSE=$(curl -s -X PUT "${API_URL}/${PAGE_ID}" \
              -H "Access-Token: ${SHOPLAZZA_ACCESS_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{
                \"page\": {
                  \"title\": \"${PAGE_TITLE}\",
                  \"published\": true
                }
              }")
          else
            echo "Creating new page..."
            RESPONSE=$(curl -s -X POST "${API_URL}" \
              -H "Access-Token: ${SHOPLAZZA_ACCESS_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{
                \"page\": {
                  \"title\": \"${PAGE_TITLE}\",
                  \"published\": true
                }
              }")
          fi

          echo "API Response:"
          echo "$RESPONSE" | jq .

          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ (2025-06 API response format)
          NEW_PAGE_ID=$(echo "$RESPONSE" | jq -r '.data.page.id // empty')
          PAGE_URL_PATH=$(echo "$RESPONSE" | jq -r '.data.page.url // empty')

          if [ -n "$NEW_PAGE_ID" ]; then
            PAGE_URL="https://${SHOPLAZZA_SHOP_DOMAIN}.myshoplaza.com${PAGE_URL_PATH}"
            echo ""
            echo "=========================================="
            echo "âœ… é¡µé¢åˆ›å»º/æ›´æ–°æˆåŠŸ!"
            echo "é¡µé¢ ID: $NEW_PAGE_ID"
            echo "é¡µé¢ URL: $PAGE_URL"
            echo ""
            echo "æ³¨æ„: é¡µé¢å†…å®¹é€šè¿‡ä¸»é¢˜æ¨¡æ¿æ¸²æŸ“"
            echo "è¯·ç¡®ä¿å·²æ¨é€ä¸»é¢˜æ–‡ä»¶åˆ° Shoplazza"
            echo "=========================================="
            echo "page_url=$PAGE_URL" >> $GITHUB_OUTPUT
          else
            echo "Error: Failed to create/update page"
            echo "$RESPONSE"
            exit 1
          fi

      - name: Create deployment summary
        if: steps.detect.outputs.first_version != ''
        run: |
          VERSION_PATH="${{ steps.detect.outputs.first_version }}"
          WORKSHOP=$(echo "$VERSION_PATH" | cut -d'/' -f2)
          PROJECT=$(echo "$VERSION_PATH" | cut -d'/' -f4)
          VERSION=$(echo "$VERSION_PATH" | cut -d'/' -f6)
          PAGE_HANDLE="ai-landing-${PROJECT}-${VERSION}"
          PAGE_URL="https://${{ secrets.SHOPLAZZA_SHOP_DOMAIN }}.myshoplaza.com/pages/${PAGE_HANDLE}"

          echo "## ğŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### éƒ¨ç½²ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **Workshop**: $WORKSHOP" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: $PROJECT" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### é¡µé¢é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— [$PAGE_URL]($PAGE_URL)" >> $GITHUB_STEP_SUMMARY
