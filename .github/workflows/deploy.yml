name: Production Deploy

on:
  push:
    branches: [main]
    paths:
      - 'workshops/**'

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-2
  SHARED_SERVICES_ACCOUNT_ID: '009661764016'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.SHARED_SERVICES_ACCOUNT_ID }}:role/GitHubActionsRole
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-LandingPages-Deploy

      - name: Detect changed versions
        id: detect
        run: |
          echo "Detecting changed versions..."

          # 获取变更的文件
          CHANGED=$(git diff --name-only HEAD~1 HEAD -- workshops/ || echo "")
          echo "Changed files:"
          echo "$CHANGED"

          # 提取唯一的 version 路径
          VERSIONS=$(echo "$CHANGED" | grep -oP 'workshops/[^/]+/[^/]+/[^/]+' | sort -u || echo "")
          echo "Changed versions:"
          echo "$VERSIONS"

          echo "versions<<EOF" >> $GITHUB_OUTPUT
          echo "$VERSIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Shoplazza CLI
        run: |
          npm install -g @shoplazza/cli
          shoplazza --version || echo "CLI installed"

      - name: Get Shoplazza credentials from SSM
        id: ssm
        run: |
          # 从 SSM Parameter Store 获取 Shoplazza 凭证
          SHOP_DOMAIN=$(aws ssm get-parameter --name "/sandwichlab/shoplazza/shop-domain" --with-decryption --query "Parameter.Value" --output text 2>/dev/null || echo "")
          ACCESS_TOKEN=$(aws ssm get-parameter --name "/sandwichlab/shoplazza/access-token" --with-decryption --query "Parameter.Value" --output text 2>/dev/null || echo "")
          THEME_ID=$(aws ssm get-parameter --name "/sandwichlab/shoplazza/theme-id" --with-decryption --query "Parameter.Value" --output text 2>/dev/null || echo "")

          if [ -n "$SHOP_DOMAIN" ]; then
            echo "shop_domain=$SHOP_DOMAIN" >> $GITHUB_OUTPUT
            echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT
            echo "theme_id=$THEME_ID" >> $GITHUB_OUTPUT
            echo "has_credentials=true" >> $GITHUB_OUTPUT
          else
            echo "Warning: SSM parameters not found, using GitHub secrets"
            echo "has_credentials=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Shoplazza
        env:
          SHOPLAZZA_SHOP_DOMAIN: ${{ steps.ssm.outputs.has_credentials == 'true' && steps.ssm.outputs.shop_domain || secrets.SHOPLAZZA_SHOP_DOMAIN }}
          SHOPLAZZA_ACCESS_TOKEN: ${{ steps.ssm.outputs.has_credentials == 'true' && steps.ssm.outputs.access_token || secrets.SHOPLAZZA_ACCESS_TOKEN }}
          SHOPLAZZA_THEME_ID: ${{ steps.ssm.outputs.has_credentials == 'true' && steps.ssm.outputs.theme_id || secrets.SHOPLAZZA_THEME_ID }}
        run: |
          echo "Deploying changed versions..."

          VERSIONS="${{ steps.detect.outputs.versions }}"

          if [ -z "$VERSIONS" ]; then
            echo "No versions to deploy"
            exit 0
          fi

          for version_path in $VERSIONS; do
            echo "Deploying: $version_path"
            theme_dir="$version_path/theme"

            if [ -d "$theme_dir" ]; then
              echo "Found theme directory: $theme_dir"
              cd "$theme_dir"
              # shoplazza theme push --theme $SHOPLAZZA_THEME_ID
              echo "Would deploy theme from $theme_dir"
              cd -
            else
              echo "Warning: No theme directory found at $theme_dir"
            fi
          done

          echo "Deployment complete"

      - name: Create deployment summary
        run: |
          echo "## 部署完成" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "已部署的版本:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.detect.outputs.versions }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
