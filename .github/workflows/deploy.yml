name: Production Deploy

on:
  push:
    branches: [main]
    paths:
      - 'workshops/**'
  workflow_dispatch:  # ÊîØÊåÅÊâãÂä®Ëß¶Âèë

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed versions
        id: detect
        run: |
          echo "Detecting changed versions..."

          # Ëé∑ÂèñÂèòÊõ¥ÁöÑÊñá‰ª∂
          CHANGED=$(git diff --name-only HEAD~1 HEAD -- workshops/ || echo "")
          echo "Changed files:"
          echo "$CHANGED"

          # ÊèêÂèñÂîØ‰∏ÄÁöÑ version Ë∑ØÂæÑ
          VERSIONS=$(echo "$CHANGED" | grep -oP 'workshops/[^/]+/projects/[^/]+/versions/[^/]+' | sort -u || echo "")
          echo "Changed versions:"
          echo "$VERSIONS"

          # ÂèñÁ¨¨‰∏Ä‰∏™ÁâàÊú¨Ë∑ØÂæÑ
          FIRST_VERSION=$(echo "$VERSIONS" | head -1)
          echo "first_version=$FIRST_VERSION" >> $GITHUB_OUTPUT

          echo "versions<<EOF" >> $GITHUB_OUTPUT
          echo "$VERSIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Deploy to Shoplazza
        if: steps.detect.outputs.first_version != ''
        env:
          SHOPLAZZA_SHOP_DOMAIN: ${{ secrets.SHOPLAZZA_SHOP_DOMAIN }}
          SHOPLAZZA_ACCESS_TOKEN: ${{ secrets.SHOPLAZZA_ACCESS_TOKEN }}
        run: |
          echo "Deploying to Shoplazza..."

          VERSION_PATH="${{ steps.detect.outputs.first_version }}"
          THEME_DIR="$VERSION_PATH/theme"

          if [ ! -d "$THEME_DIR" ]; then
            echo "Error: Theme directory not found: $THEME_DIR"
            exit 1
          fi

          # Ê£ÄÊü•Âá≠ËØÅ
          if [ -z "$SHOPLAZZA_SHOP_DOMAIN" ] || [ -z "$SHOPLAZZA_ACCESS_TOKEN" ]; then
            echo "Error: Missing Shoplazza credentials"
            echo "Please set SHOPLAZZA_SHOP_DOMAIN and SHOPLAZZA_ACCESS_TOKEN secrets"
            exit 1
          fi

          echo "Theme directory: $THEME_DIR"
          echo "Shop domain: $SHOPLAZZA_SHOP_DOMAIN"

          # ËØªÂèñ page_detail.liquid ÂÜÖÂÆπ
          LIQUID_FILE="$THEME_DIR/sections/page_detail.liquid"
          if [ ! -f "$LIQUID_FILE" ]; then
            echo "Error: page_detail.liquid not found"
            exit 1
          fi

          echo "Found Liquid file: $LIQUID_FILE"
          echo "File size: $(wc -c < "$LIQUID_FILE") bytes"

          # ÊèêÂèñÁâàÊú¨‰ø°ÊÅØÁî®‰∫éÈ°µÈù¢ handle
          # Ë∑ØÂæÑÊ†ºÂºè: workshops/spring-festival/projects/landing/versions/v14
          WORKSHOP=$(echo "$VERSION_PATH" | cut -d'/' -f2)
          PROJECT=$(echo "$VERSION_PATH" | cut -d'/' -f4)
          VERSION=$(echo "$VERSION_PATH" | cut -d'/' -f6)
          PAGE_HANDLE="ai-landing-${PROJECT}-${VERSION}"

          echo "Workshop: $WORKSHOP"
          echo "Project: $PROJECT"
          echo "Version: $VERSION"
          echo "Page handle: $PAGE_HANDLE"

          # ÂàõÂª∫/Êõ¥Êñ∞È°µÈù¢
          API_URL="https://${SHOPLAZZA_SHOP_DOMAIN}.myshoplaza.com/openapi/2024-04/pages"

          # ËØªÂèñÂπ∂ËΩ¨‰πâ Liquid ÂÜÖÂÆπ
          LIQUID_CONTENT=$(cat "$LIQUID_FILE" | jq -Rs .)

          # Ê£ÄÊü•È°µÈù¢ÊòØÂê¶Â∑≤Â≠òÂú®
          echo "Checking if page exists..."
          EXISTING=$(curl -s -X GET "${API_URL}?handle=${PAGE_HANDLE}" \
            -H "Access-Token: ${SHOPLAZZA_ACCESS_TOKEN}" \
            -H "Content-Type: application/json")

          PAGE_ID=$(echo "$EXISTING" | jq -r '.pages[0].id // empty')

          if [ -n "$PAGE_ID" ]; then
            echo "Page exists (ID: $PAGE_ID), updating..."
            RESPONSE=$(curl -s -X PUT "${API_URL}/${PAGE_ID}" \
              -H "Access-Token: ${SHOPLAZZA_ACCESS_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{
                \"page\": {
                  \"title\": \"AI Landing Page - ${PROJECT} ${VERSION}\",
                  \"handle\": \"${PAGE_HANDLE}\",
                  \"body_html\": ${LIQUID_CONTENT},
                  \"published\": true
                }
              }")
          else
            echo "Creating new page..."
            RESPONSE=$(curl -s -X POST "${API_URL}" \
              -H "Access-Token: ${SHOPLAZZA_ACCESS_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{
                \"page\": {
                  \"title\": \"AI Landing Page - ${PROJECT} ${VERSION}\",
                  \"handle\": \"${PAGE_HANDLE}\",
                  \"body_html\": ${LIQUID_CONTENT},
                  \"published\": true
                }
              }")
          fi

          echo "API Response:"
          echo "$RESPONSE" | jq .

          # Ê£ÄÊü•ÊòØÂê¶ÊàêÂäü
          NEW_PAGE_ID=$(echo "$RESPONSE" | jq -r '.page.id // empty')
          if [ -n "$NEW_PAGE_ID" ]; then
            PAGE_URL="https://${SHOPLAZZA_SHOP_DOMAIN}.myshoplaza.com/pages/${PAGE_HANDLE}"
            echo ""
            echo "=========================================="
            echo "‚úÖ ÈÉ®ÁΩ≤ÊàêÂäü!"
            echo "È°µÈù¢ URL: $PAGE_URL"
            echo "=========================================="
            echo "page_url=$PAGE_URL" >> $GITHUB_OUTPUT
          else
            echo "Error: Failed to create/update page"
            echo "$RESPONSE"
            exit 1
          fi

      - name: Create deployment summary
        if: steps.detect.outputs.first_version != ''
        run: |
          VERSION_PATH="${{ steps.detect.outputs.first_version }}"
          WORKSHOP=$(echo "$VERSION_PATH" | cut -d'/' -f2)
          PROJECT=$(echo "$VERSION_PATH" | cut -d'/' -f4)
          VERSION=$(echo "$VERSION_PATH" | cut -d'/' -f6)
          PAGE_HANDLE="ai-landing-${PROJECT}-${VERSION}"
          PAGE_URL="https://${{ secrets.SHOPLAZZA_SHOP_DOMAIN }}.myshoplaza.com/pages/${PAGE_HANDLE}"

          echo "## üöÄ ÈÉ®ÁΩ≤ÂÆåÊàê" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ÈÉ®ÁΩ≤‰ø°ÊÅØ" >> $GITHUB_STEP_SUMMARY
          echo "- **Workshop**: $WORKSHOP" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: $PROJECT" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### È°µÈù¢ÈìæÊé•" >> $GITHUB_STEP_SUMMARY
          echo "üîó [$PAGE_URL]($PAGE_URL)" >> $GITHUB_STEP_SUMMARY
